# Mamba-Adaptive扫描路径生成模型 - 架构可视化说明

## 📐 模型架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     输入层                                       │
│             360度图像 (B, 3, 256, 512)                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Glance网络（全局特征提取）                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │SphereConv│→ │SphereConv│→ │SphereConv│→ │SphereConv│      │
│  │ 3→64     │  │ 64→128   │  │128→256   │  │256→512   │      │
│  └──────────┘  └────┬─────┘  └──────────┘  └────┬─────┘      │
│                     │                            │             │
│                  [ECA]                        [ECA]             │
│                     │                            │             │
│                     └──────────┬─────────────────┘             │
│                                ▼                                │
│                    AdaptivePool(14×14)                          │
│                                ▼                                │
│                    Linear(512→384)                              │
│                                ▼                                │
│              全局特征 (B, 196, 384)                             │
└────────────────────────┬───────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              序列生成循环（30步）                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 步骤 t                                                    │  │
│  │                                                            │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 1. 根据当前位置crop局部patch (224×224)            │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 2. Focus网络提取局部特征                           │  │  │
│  │  │    Conv→Conv→Conv→Conv + ECA                       │  │  │
│  │  │    输出: (B, 196, 384)                            │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 3. 特征更新（Cross-Attention）                      │  │  │
│  │  │    全局特征 ← 局部特征（空间权重）                  │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 4. 特征融合（门控融合）                              │  │  │
│  │  │    全局上下文 + 局部上下文                          │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 5. 位置编码（周期性编码）                            │  │  │
│  │  │    X: [sin(2πx), cos(2πx)]                         │  │  │
│  │  │    Y: y                                            │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 6. 空间注意力                                       │  │  │
│  │  │    MultiheadAttention(query, key, value)          │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 7. Mamba序列建模                                    │  │  │
│  │  │    累积历史序列 → Mamba → 当前状态                  │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 8. VAE概率预测                                      │  │  │
│  │  │    编码器: mu, logvar                              │  │  │
│  │  │    重参数化: z = mu + eps*sigma                    │  │  │
│  │  │    解码器: z → 位置 (B, 2)                         │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 9. Y方向注意力偏置                                  │  │  │
│  │  │    鼓励Y方向多样性                                 │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 10. Wrap around处理                                 │  │  │
│  │  │     X: wrap around                                 │  │  │
│  │  │     Y: clamp                                       │  │  │
│  │  └────────────────┬───────────────────────────────────┘  │  │
│  │                   ▼                                       │  │
│  │              预测位置 (B, 2)                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬───────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                     输出层                                       │
│           完整扫描路径 (B, 30, 2)                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 核心组件详解

### 1. Glance网络架构

```
输入: (B, 3, 256, 512)
    │
    ▼
┌─────────────────┐
│ SphereConv2D    │ stride=2
│ 3 → 64         │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
    [LeakyReLU]
         │
         ▼
┌─────────────────┐
│ SphereConv2D    │ stride=2
│ 64 → 128       │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
    [LeakyReLU]
         │
         ▼
      [ECA] ← 通道注意力
         │
         ▼
┌─────────────────┐
│ SphereConv2D    │ stride=2
│ 128 → 256      │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
    [LeakyReLU]
         │
         ▼
┌─────────────────┐
│ SphereConv2D    │ stride=2
│ 256 → 512      │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
    [LeakyReLU]
         │
         ▼
      [ECA] ← 通道注意力
         │
         ▼
┌─────────────────┐
│ AdaptiveAvgPool │
│ → (14, 14)      │
└────────┬────────┘
         │
         ▼
    Reshape
    (B, 196, 512)
         │
         ▼
┌─────────────────┐
│ Linear          │
│ 512 → 384      │
└────────┬────────┘
         │
         ▼
输出: (B, 196, 384)
```

### 2. Focus网络架构

```
输入: (B, 3, 224, 224)
    │
    ▼
┌─────────────────┐
│ Conv2d         │ 7×7, stride=2
│ 3 → 64         │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
      [ReLU]
         │
         ▼
    [MaxPool] 3×3, stride=2
         │
         ▼
┌─────────────────┐
│ Conv2d         │ 3×3, stride=2
│ 64 → 128       │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
      [ReLU]
         │
         ▼
┌─────────────────┐
│ Conv2d         │ 3×3, stride=2
│ 128 → 256      │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
      [ReLU]
         │
         ▼
┌─────────────────┐
│ Conv2d         │ 3×3, stride=2
│ 256 → 512      │
└────────┬────────┘
         │
         ▼
    [BatchNorm]
         │
         ▼
      [ReLU]
         │
         ▼
      [ECA] ← 通道注意力
         │
         ▼
┌─────────────────┐
│ AdaptiveAvgPool │
│ → (14, 14)      │
└────────┬────────┘
         │
         ▼
    Reshape
    (B, 196, 512)
         │
         ▼
┌─────────────────┐
│ Linear          │
│ 512 → 384      │
└────────┬────────┘
         │
         ▼
输出: (B, 196, 384)
```

### 3. Mamba序列建模流程

```
历史特征序列: [h_0, h_1, ..., h_{t-1}]
    │
    ▼
┌─────────────────────────────────┐
│ 累积最近10步                     │
│ recent_history = [-10:]          │
└────────────┬────────────────────┘
             │
             ▼
    Stack → (T, B, C)
             │
             ▼
    Transpose → (B, T, C)
             │
             ▼
┌─────────────────────────────────┐
│ Mamba状态空间模型                │
│ - 选择性机制                     │
│ - 长期依赖建模                   │
│ - O(n)复杂度                     │
└────────────┬────────────────────┘
             │
             ▼
    输出: (B, T, C)
             │
             ▼
    取最后一步: (B, 1, C)
             │
             ▼
    当前状态 h_t
```

### 4. VAE概率建模流程

```
Mamba输出 + 当前特征 + 位置信息
    │
    ▼
┌─────────────────────────────────┐
│ 编码器（均值）                   │
│ Linear(384+4 → 384)             │
│ → LayerNorm → GELU              │
│ → Dropout                       │
│ → Linear(384 → 192)             │
└────────────┬────────────────────┘
             │
             ▼
          mu (B, 192)
    │
    ▼
┌─────────────────────────────────┐
│ 编码器（对数方差）                │
│ Linear(384+4 → 384)             │
│ → LayerNorm → GELU              │
│ → Dropout                       │
│ → Linear(384 → 192)             │
└────────────┬────────────────────┘
             │
             ▼
       logvar (B, 192)
    │
    ▼
┌─────────────────────────────────┐
│ 重参数化技巧                     │
│ std = exp(0.5 * logvar)         │
│ eps ~ N(0, 1)                   │
│ z = mu + eps * std * temp       │
└────────────┬────────────────────┘
             │
             ▼
       z (B, 192)
    │
    ▼
┌─────────────────────────────────┐
│ 解码器                           │
│ Linear(192+4 → 192)             │
│ → LayerNorm → GELU              │
│ → Dropout                       │
│ → Linear(192 → 96)              │
│ → LayerNorm → GELU              │
│ → Dropout                       │
│ → Linear(96 → 48)               │
│ → LayerNorm → GELU              │
│ → Linear(48 → 2)                │
│ → Tanh → [0, 1]                 │
└────────────┬────────────────────┘
             │
             ▼
    预测位置 (B, 2)
```

### 5. 特征更新机制

```
全局特征 (B, 196, 384)
    │
    ▼
┌─────────────────────────────────┐
│ 计算空间权重                     │
│ - 基于当前位置                   │
│ - 高斯分布                       │
│ - 考虑wrap around               │
└────────────┬────────────────────┘
             │
             ▼
    空间权重 (B, 196, 1)
    │
    ▼
┌─────────────────────────────────┐
│ 局部特征聚合                     │
│ local_features.mean(dim=1)       │
└────────────┬────────────────────┘
             │
             ▼
    局部聚合 (B, 1, 384)
    │
    ▼
┌─────────────────────────────────┐
│ 广播更新信号                     │
│ update_signal =                  │
│   local_aggregate *              │
│   spatial_weights                │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 门控融合                         │
│ gate = sigmoid(                  │
│   Linear([global; update])      │
│ )                                │
│ updated = gate * update +        │
│          (1-gate) * global       │
└────────────┬────────────────────┘
             │
             ▼
    更新后的全局特征 (B, 196, 384)
```

---

## 🔄 数据流图

### 单步生成流程

```
时间步 t-1 的位置: pos_{t-1} (B, 2)
    │
    ├─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
┌──────────────┐                  ┌──────────────┐
│ Crop Patch   │                  │ 位置编码      │
│ (224×224)    │                  │ [sin,cos,y]  │
└──────┬───────┘                  └──────┬───────┘
       │                                  │
       ▼                                  ▼
┌──────────────┐                  ┌──────────────┐
│ Focus网络    │                  │ 位置特征      │
│ 局部特征     │                  │ (B, 384)      │
└──────┬───────┘                  └──────┬───────┘
       │                                  │
       └──────────┬───────────────────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 特征更新         │
         │ 全局 ← 局部      │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 特征融合         │
         │ 全局 + 局部      │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 空间注意力       │
         │ MultiheadAttn    │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ Mamba序列建模    │
         │ 历史序列 → 状态  │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ VAE概率预测      │
         │ mu, logvar → z   │
         │ z → 位置         │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ Y方向偏置        │
         │ 增加多样性       │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ Wrap around      │
         │ X: %, Y: clamp   │
         └────────┬─────────┘
                  │
                  ▼
      时间步 t 的位置: pos_t (B, 2)
```

---

## 📊 参数量统计

### 各组件参数量

```
Glance网络:
  - SphereConv2D: ~1.5M
  - ECA: ~10K
  - Linear: ~200K
  小计: ~1.7M

Focus网络:
  - Conv2d: ~1.2M
  - ECA: ~10K
  - Linear: ~200K
  小计: ~1.4M

Mamba模块:
  - SSM参数: ~800K
  - 其他: ~200K
  小计: ~1M

特征更新:
  - CrossAttention: ~300K
  - 门控融合: ~150K
  小计: ~450K

VAE:
  - 编码器: ~200K
  - 解码器: ~150K
  小计: ~350K

其他:
  - 位置编码: ~100K
  - Y方向注意力: ~50K
  - 停止分类器: ~50K
  小计: ~200K

─────────────────────────
总计: ~6M 参数
```

---

## ⚡ 计算复杂度分析

### 各组件FLOPs

```
Glance网络（一次）:
  - SphereConv: ~50M FLOPs
  小计: ~50M

Focus网络（每步）:
  - Conv2d: ~20M FLOPs × 30步
  小计: ~600M

Mamba（每步）:
  - SSM: ~1.5M FLOPs × 30步
  小计: ~45M

特征更新（每步）:
  - CrossAttention: ~75K FLOPs × 30步
  小计: ~2.25M

VAE（每步）:
  - 编码/解码: ~100K FLOPs × 30步
  小计: ~3M

其他（每步）:
  - 位置编码等: ~50K FLOPs × 30步
  小计: ~1.5M

─────────────────────────
总计: ~700M FLOPs
```

---

## 🎯 关键设计决策

### 1. 为什么选择Mamba而不是Transformer？

```
Transformer:
  - 复杂度: O(n²)
  - 自注意力: 计算所有位置对
  - 长序列: 内存和计算开销大

Mamba:
  - 复杂度: O(n)
  - 状态空间: 线性扫描
  - 长序列: 高效处理
  - 选择性: 动态选择重要信息
```

### 2. 为什么需要双流架构？

```
Glance流:
  - 快速全局理解
  - 低分辨率但覆盖全图
  - 提供上下文信息

Focus流:
  - 精细局部分析
  - 高分辨率细节
  - 根据注视点动态提取

协同:
  - 全局指导局部
  - 局部更新全局
  - 动态平衡
```

### 3. 为什么使用VAE而不是直接预测？

```
直接预测:
  - 容易过拟合
  - 缺乏多样性
  - 确定性输出

VAE:
  - 概率建模
  - 增加多样性
  - 防止过拟合
  - 温度控制
```

---

## 📝 总结

本模型通过以下关键设计实现了高效的扫描路径生成：

1. **Mamba序列建模**：O(n)复杂度，长期依赖
2. **双流特征提取**：全局-局部协同
3. **360度图像适配**：球面卷积、wrap around
4. **VAE概率建模**：增加多样性，防止过拟合
5. **多损失函数组合**：精确对齐，平滑轨迹

总参数量约6M，单次前向传播约700M FLOPs，在保持高效的同时实现了良好的性能。

---

**文档生成时间**：2024年
**模型版本**：Mamba-Adaptive Scanpath Generator v1.0
