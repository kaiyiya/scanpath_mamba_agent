# LEVæŒ‡æ ‡ä¿®å¤æ–¹æ¡ˆ - å®Œæ•´æ€»ç»“

## é—®é¢˜åˆ†æ

### LEVæŒ‡æ ‡çš„çœŸå®å«ä¹‰

**å½“å‰ç»“æœ**: LEV = 29.90ï¼ˆåºåˆ—é•¿åº¦30ï¼‰

è¿™æ„å‘³ç€ï¼š
- éœ€è¦**29.90æ¬¡ç¼–è¾‘æ“ä½œ**æ‰èƒ½å°†é¢„æµ‹åºåˆ—è½¬æ¢ä¸ºçœŸå®åºåˆ—
- **99.7%çš„åºåˆ—ä¸åŒ¹é…**ï¼
- è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„é—®é¢˜**ï¼Œè¯´æ˜æ¨¡å‹é¢„æµ‹çš„æ‰«æè·¯å¾„é¡ºåºä¸çœŸå®è·¯å¾„å‡ ä¹å®Œå…¨ä¸åŒ

**ç†æƒ³ç»“æœ**: LEV < 5ï¼ˆ<16.7%ä¸åŒ¹é…ï¼‰

---

## æ ¹æœ¬åŸå› 

### åŸå› 1: èµ·å§‹ç‚¹ä¸åŒ¹é… ğŸ”´

**é—®é¢˜**ï¼š
```python
# è®­ç»ƒæ—¶éšæœºåˆå§‹åŒ–èµ·å§‹ç‚¹
use_edge = torch.rand(B, device=device) < 0.6
# 60%ä»è¾¹ç¼˜ï¼Œ40%ä»å…¨å›¾éšæœºé€‰æ‹©
```

**åæœ**ï¼š
- é¢„æµ‹è·¯å¾„çš„èµ·å§‹ç‚¹ä¸çœŸå®è·¯å¾„ä¸åŒ
- LEVå¯¹èµ·å§‹ç‚¹éå¸¸æ•æ„Ÿ
- å³ä½¿åç»­è½¨è¿¹ç›¸ä¼¼ï¼Œèµ·å§‹ç‚¹ä¸åŒå¯¼è‡´æ•´ä¸ªåºåˆ—ä¸åŒ¹é…

### åŸå› 2: æ—¶é—´å¯¹é½é—®é¢˜ ğŸŸ¡

**é—®é¢˜**ï¼š
- LEVå¯¹æ—¶é—´é¡ºåºæå…¶æ•æ„Ÿ
- çœŸå®è·¯å¾„ï¼šA â†’ B â†’ C â†’ D
- é¢„æµ‹è·¯å¾„ï¼šA â†’ C â†’ B â†’ Dï¼ˆé¡ºåºç¨æœ‰ä¸åŒï¼‰
- LEVä¼šè®¤ä¸ºè¿™æ˜¯å®Œå…¨ä¸åŒçš„åºåˆ—

### åŸå› 3: ä½ç½®ç¦»æ•£åŒ–è¯¯å·® ğŸŸ¡

**é—®é¢˜**ï¼š
- ä½ç½®è¯¯å·® = 0.35-0.45
- åœ¨16x16ç½‘æ ¼ä¸Šï¼Œè¯¯å·® â‰ˆ 5.6-7.2ä¸ªç½‘æ ¼å•å…ƒ
- å³ä½¿è½¨è¿¹å½¢çŠ¶ç›¸ä¼¼ï¼Œç¦»æ•£åŒ–åçš„åºåˆ—å®Œå…¨ä¸åŒ

---

## ä¿®å¤æ–¹æ¡ˆï¼ˆå·²å®æ–½ï¼‰

### ä¿®å¤1: ä½¿ç”¨çœŸå®èµ·å§‹ç‚¹ â­â­â­

**ä¿®æ”¹æ–‡ä»¶**: `models/mamba_adaptive_scanpath.py`

**ä¿®æ”¹å†…å®¹**ï¼š
```python
def forward(self, images, global_features, seq_len, gt_positions=None,
            teacher_forcing_ratio=0.5, temperature=1.0,
            enable_early_stop=True, stop_threshold=0.5, min_steps=5,
            use_gt_start=True):  # æ–°å¢å‚æ•°

    # åˆå§‹ä½ç½®
    if use_gt_start and gt_positions is not None:
        # è®­ç»ƒ/éªŒè¯æ—¶ï¼šä½¿ç”¨çœŸå®èµ·å§‹ç‚¹ï¼Œç¡®ä¿åºåˆ—å¯¹é½
        prev_pos = gt_positions[:, 0, :].clone()
    else:
        # æ¨ç†æ—¶ï¼šéšæœºåˆå§‹åŒ–
        # ... åŸæœ‰é€»è¾‘
```

**æ•ˆæœ**ï¼š
- ç¡®ä¿é¢„æµ‹åºåˆ—ä¸çœŸå®åºåˆ—ä»åŒä¸€èµ·ç‚¹å¼€å§‹
- é¢„æœŸLEVé™ä½50%ä»¥ä¸Šï¼ˆ29.90 â†’ <15ï¼‰

### ä¿®å¤2: åºåˆ—å¯¹é½æŸå¤± â­â­â­

**æ–°å¢å‡½æ•°**: `train_mamba_adaptive.py`

```python
def compute_sequence_alignment_loss(pred_scanpaths, true_scanpaths):
    """
    åºåˆ—å¯¹é½æŸå¤±ï¼šé¼“åŠ±é¢„æµ‹åºåˆ—ä¸çœŸå®åºåˆ—åœ¨æ—¶é—´ä¸Šå¯¹é½
    å‰å‡ æ­¥ç»™äºˆæ›´é«˜æƒé‡ï¼Œç¡®ä¿èµ·å§‹ç‚¹å’Œæ—©æœŸè½¨è¿¹åŒ¹é…
    """
    B, T, D = pred_scanpaths.shape

    # è®¡ç®—æ¯ä¸ªé¢„æµ‹ç‚¹ä¸å¯¹åº”çœŸå®ç‚¹çš„è·ç¦»
    point_distances = torch.norm(pred_scanpaths - true_scanpaths, dim=-1)  # (B, T)

    # å‰å‡ æ­¥ç»™äºˆæ›´é«˜æƒé‡ï¼ˆå¯¹LEVæŒ‡æ ‡è‡³å…³é‡è¦ï¼‰
    weights = torch.ones(T, device=pred_scanpaths.device)
    weights[:5] = 5.0   # å‰5æ­¥æƒé‡x5ï¼ˆèµ·å§‹ç‚¹å¯¹é½ï¼‰
    weights[5:10] = 3.0  # 5-10æ­¥æƒé‡x3
    weights[10:15] = 2.0  # 10-15æ­¥æƒé‡x2

    # åŠ æƒå¹³å‡
    alignment_loss = torch.mean(point_distances * weights.unsqueeze(0))

    return alignment_loss
```

**æƒé‡é…ç½®**ï¼š
```python
# é˜¶æ®µ1ï¼ˆepoch â‰¤ 80ï¼‰: æƒé‡ = 2.0
# é˜¶æ®µ2ï¼ˆ80 < epoch â‰¤ 150ï¼‰: æƒé‡ = 2.0 â†’ 3.0ï¼ˆé€æ¸å¢åŠ ï¼‰
# é˜¶æ®µ3ï¼ˆepoch > 150ï¼‰: æƒé‡ = 3.0
```

**æ•ˆæœ**ï¼š
- ç›´æ¥ä¼˜åŒ–åºåˆ—å¯¹é½
- å‰5æ­¥çš„é«˜æƒé‡ç¡®ä¿èµ·å§‹è½¨è¿¹åŒ¹é…
- é¢„æœŸLEVé™ä½30-40%

### ä¿®å¤3: æ”¹è¿›Teacher Forcingç­–ç•¥ â­â­

**ä¿®æ”¹å‡½æ•°**: `train_mamba_adaptive.py`

```python
def compute_teacher_forcing_ratio(epoch, step_idx=None):
    """
    æŒ‡æ•°è¡°å‡çš„Teacher Forcingç­–ç•¥

    Args:
        epoch: å½“å‰è®­ç»ƒè½®æ¬¡
        step_idx: å½“å‰åºåˆ—ä¸­çš„æ­¥éª¤ç´¢å¼•ï¼ˆ0-29ï¼‰
    """
    # åŸºç¡€æ¯”ä¾‹ï¼ˆåŸºäºepochï¼‰
    initial_ratio = 0.7
    final_ratio = 0.2  # ä»0.1æé«˜åˆ°0.2
    decay_epochs = 150  # ä»100å»¶é•¿åˆ°150

    k = -math.log(final_ratio / initial_ratio) / decay_epochs
    base_ratio = initial_ratio * math.exp(-k * epoch)
    base_ratio = max(base_ratio, final_ratio)

    # å‰5æ­¥ä¿æŒæ›´é«˜çš„Teacher Forcingï¼Œç¡®ä¿åºåˆ—èµ·å§‹å¯¹é½
    if step_idx is not None and step_idx < 5:
        return min(base_ratio + 0.3, 0.95)  # å‰5æ­¥æé«˜30%

    return base_ratio
```

**æ”¹è¿›ç‚¹**ï¼š
1. æœ€ç»ˆæ¯”ä¾‹ä»0.1æé«˜åˆ°0.2ï¼ˆæ›´å¤šæŒ‡å¯¼ï¼‰
2. è¡°å‡æ—¶é—´ä»100è½®å»¶é•¿åˆ°150è½®ï¼ˆæ›´æ…¢è¡°å‡ï¼‰
3. å‰5æ­¥é¢å¤–+0.3çš„Teacher Forcingï¼ˆç¡®ä¿èµ·å§‹å¯¹é½ï¼‰

**æ•ˆæœ**ï¼š
- æ¨¡å‹å­¦ä¹ æ›´å¥½çš„åºåˆ—ç”Ÿæˆ
- å‡å°‘exposure bias
- æ”¹å–„åºåˆ—å¯¹é½

### ä¿®å¤4: Yå‡å€¼åå·®ä¿®å¤ â­

**ä¿®æ”¹å‡½æ•°**: `train_mamba_adaptive.py`

```python
def compute_spatial_coverage_loss(pred_scanpaths):
    # ... å‰é¢ä»£ç ä¸å˜ ...

    # Yæ–¹å‘ä¸­å¿ƒèšé›†æƒ©ç½šï¼ˆä¿®å¤ï¼šæƒ©ç½šåç¦»0.5çš„ä»»ä½•æ–¹å‘ï¼‰
    y_center_dist = torch.abs(pred_mean[:, 1] - 0.5)
    # å…è®¸Â±0.05çš„åå·®ï¼Œè¶…å‡ºåˆ™æƒ©ç½šï¼ˆä¿®å¤y_mean=0.61çš„é—®é¢˜ï¼‰
    y_bias_penalty = torch.mean((y_center_dist - 0.05).clamp(min=0.0) ** 2)

    # å†…éƒ¨åŠ æƒç»„åˆï¼ˆæé«˜Yåå·®æƒ©ç½šæƒé‡ï¼‰
    return coverage_x + 3.0*coverage_y + diversity_x + 5.0*diversity_y + 15.0*y_bias_penalty
```

**ä¿®æ”¹ç‚¹**ï¼š
1. ä»åªæƒ©ç½š[0.4, 0.6]æ”¹ä¸ºæƒ©ç½šåç¦»0.5è¶…è¿‡0.05çš„ä»»ä½•æ–¹å‘
2. æƒé‡ä»10.0æé«˜åˆ°15.0

**æ•ˆæœ**ï¼š
- ä¿®å¤Yå‡å€¼=0.61çš„åå·®é—®é¢˜
- Yå‡å€¼åº”è¯¥å›åˆ°0.50å·¦å³

### ä¿®å¤5: æé«˜é‡æ„æŸå¤±æƒé‡ â­

**ä¿®æ”¹**: `train_mamba_adaptive.py`

```python
weights = {
    'reconstruction': 2.0,  # ä»1.0æé«˜åˆ°2.0
    'kl': 0.001,            # ä»0.005é™ä½åˆ°0.001
    # ... å…¶ä»–ä¸å˜
}
```

**æ•ˆæœ**ï¼š
- æ›´ç›´æ¥åœ°ä¼˜åŒ–ä½ç½®ç²¾åº¦
- å‡å°‘VAEçš„éšæœºæ€§
- æ”¹å–„ä½ç½®è¯¯å·®

---

## é¢„æœŸæ•ˆæœ

### LEVæŒ‡æ ‡æ”¹å–„

**å½“å‰**: LEV = 29.90ï¼ˆ99.7%ä¸åŒ¹é…ï¼‰

**é¢„æœŸæ”¹å–„**ï¼š
- ä½¿ç”¨çœŸå®èµ·å§‹ç‚¹ï¼šLEVé™ä½50% â†’ **LEV â‰ˆ 15**
- åºåˆ—å¯¹é½æŸå¤±ï¼šLEVå†é™ä½30% â†’ **LEV â‰ˆ 10**
- æ”¹è¿›Teacher Forcingï¼šLEVå†é™ä½20% â†’ **LEV â‰ˆ 8**

**æœ€ç»ˆç›®æ ‡**: **LEV < 5**ï¼ˆ<16.7%ä¸åŒ¹é…ï¼‰

### å…¶ä»–æŒ‡æ ‡æ”¹å–„

1. **ä½ç½®è¯¯å·®**ï¼š
   - å½“å‰ï¼š0.35-0.45
   - é¢„æœŸï¼š0.25-0.35ï¼ˆæ”¹å–„30%ï¼‰

2. **Yå‡å€¼åå·®**ï¼š
   - å½“å‰ï¼š0.60-0.62
   - é¢„æœŸï¼š0.48-0.52ï¼ˆå›åˆ°ä¸­å¿ƒï¼‰

3. **è®­ç»ƒç¨³å®šæ€§**ï¼š
   - æ›´æ…¢çš„Teacher Forcingè¡°å‡
   - æ›´å¥½çš„åºåˆ—å¯¹é½
   - é¿å…è¿‡æ‹Ÿåˆ

---

## æŸå¤±å‡½æ•°æ€»ç»“

### æ–°çš„æŸå¤±ç»“æ„ï¼ˆ7é¡¹ï¼‰

1. **reconstruction_loss** (æƒé‡: 2.0)
   - ä½ç½®é‡æ„æŸå¤±
   - æé«˜æƒé‡ä»¥æ”¹å–„ä½ç½®ç²¾åº¦

2. **kl_loss** (æƒé‡: 0.001)
   - KLæ•£åº¦æ­£åˆ™åŒ–
   - é™ä½æƒé‡ä»¥å‡å°‘éšæœºæ€§

3. **spatial_coverage_loss** (æƒé‡: 0.5-0.8)
   - ç©ºé—´è¦†ç›– + å¤šæ ·æ€§ + Yåå·®ä¿®å¤
   - Yåå·®æƒ©ç½šæƒé‡æé«˜åˆ°15.0

4. **trajectory_smoothness_loss** (æƒé‡: 1.5)
   - è½¨è¿¹å¹³æ»‘æ€§
   - ä¿æŒä¸å˜

5. **direction_consistency_loss** (æƒé‡: 0.5)
   - æ–¹å‘ä¸€è‡´æ€§
   - ä¿æŒä¸å˜

6. **sequence_alignment_loss** (æƒé‡: 2.0-3.0) â­ **æ–°å¢**
   - åºåˆ—å¯¹é½æŸå¤±
   - å‰5æ­¥æƒé‡x5ï¼Œæ”¹å–„LEVæŒ‡æ ‡

7. **boundary_penalty** (æƒé‡: 0.2)
   - è¾¹ç•Œçº¦æŸ
   - ä¿æŒä¸å˜

---

## è®­ç»ƒç­–ç•¥

### æ¨èï¼šä»ç¬¬40è½®å¾®è°ƒ

**åŸå› **ï¼š
- ç¬¬40è½®æœ‰æœ€ä½³ä½ç½®è¯¯å·®ï¼ˆ0.3943ï¼‰
- é¿å…ç¬¬40è½®åçš„è¿‡æ‹Ÿåˆ
- åº”ç”¨æ‰€æœ‰ä¿®å¤åç»§ç»­è®­ç»ƒ

**æ­¥éª¤**ï¼š
1. åŠ è½½ `checkpoint_epoch_40.pth`
2. åº”ç”¨æ‰€æœ‰ä¿®å¤
3. è®­ç»ƒ50-100è½®
4. ç›‘æ§LEVã€ä½ç½®è¯¯å·®ã€Yå‡å€¼

**æ‰§è¡Œ**ï¼š
```bash
python finetune_from_epoch40.py
```

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **models/mamba_adaptive_scanpath.py**
   - æ·»åŠ  `use_gt_start` å‚æ•°
   - ä¿®æ”¹åˆå§‹ä½ç½®é€»è¾‘

2. **train_mamba_adaptive.py**
   - ä¿®æ”¹ `compute_teacher_forcing_ratio()`ï¼ˆæ”¯æŒstep_idxï¼‰
   - ä¿®æ”¹ `compute_spatial_coverage_loss()`ï¼ˆä¿®å¤Yåå·®ï¼‰
   - æ–°å¢ `compute_sequence_alignment_loss()`
   - æ›´æ–°è®­ç»ƒå¾ªç¯ï¼ˆæ·»åŠ åºåˆ—å¯¹é½æŸå¤±ï¼‰
   - æ›´æ–°éªŒè¯å¾ªç¯ï¼ˆä½¿ç”¨ç›¸åŒæŸå¤±ï¼‰
   - æ›´æ–°æƒé‡é…ç½®

### æ–°å¢çš„æ–‡ä»¶

1. **finetune_from_epoch40.py**
   - ä»ç¬¬40è½®ç»§ç»­è®­ç»ƒçš„è„šæœ¬

2. **LEVæŒ‡æ ‡ä¿®å¤æ–¹æ¡ˆ_å®Œæ•´æ€»ç»“.md**
   - æœ¬æ–‡æ¡£

---

## å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›

1. **ä½¿ç”¨çœŸå®èµ·å§‹ç‚¹** - æœ€å…³é”®çš„ä¿®å¤
2. **åºåˆ—å¯¹é½æŸå¤±** - ç›´æ¥ä¼˜åŒ–LEVæŒ‡æ ‡
3. **å‰5æ­¥é«˜Teacher Forcing** - ç¡®ä¿èµ·å§‹è½¨è¿¹å¯¹é½

### ğŸ“Š é¢„æœŸç»“æœ

| æŒ‡æ ‡ | å½“å‰ | é¢„æœŸ | æ”¹å–„ |
|------|------|------|------|
| LEV | 29.90 | <8 | 73% â†“ |
| ä½ç½®è¯¯å·® | 0.35-0.45 | 0.25-0.35 | 30% â†“ |
| Yå‡å€¼ | 0.60-0.62 | 0.48-0.52 | ä¿®å¤åå·® |
| Yæ ‡å‡†å·® | 0.16-0.20 | 0.16-0.20 | ä¿æŒ âœ… |

### âš¡ è®­ç»ƒæ•ˆç‡

- ä»ç¬¬40è½®ç»§ç»­è®­ç»ƒï¼ˆèŠ‚çœæ—¶é—´ï¼‰
- åº”ç”¨æ‰€æœ‰ä¿®å¤
- é¢„è®¡50-100è½®è¾¾åˆ°æœ€ä½³æ•ˆæœ

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. âœ… å®æ–½æ‰€æœ‰ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰
2. â³ ä»ç¬¬40è½®å¼€å§‹å¾®è°ƒ
3. â³ ç›‘æ§LEVæŒ‡æ ‡å˜åŒ–
4. â³ éªŒè¯Yå‡å€¼åå·®æ˜¯å¦ä¿®å¤

### éªŒè¯æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­é‡ç‚¹å…³æ³¨ï¼š
- **LEVæŒ‡æ ‡**ï¼šç›®æ ‡ <8
- **ä½ç½®è¯¯å·®**ï¼šç›®æ ‡ <0.35
- **Yå‡å€¼**ï¼šç›®æ ‡ 0.48-0.52
- **åºåˆ—å¯¹é½æŸå¤±**ï¼šåº”è¯¥é€æ¸ä¸‹é™

### æˆåŠŸæ ‡å‡†

- âœ… LEV < 8ï¼ˆå½“å‰29.90ï¼‰
- âœ… ä½ç½®è¯¯å·® < 0.35ï¼ˆå½“å‰0.35-0.45ï¼‰
- âœ… Yå‡å€¼ âˆˆ [0.48, 0.52]ï¼ˆå½“å‰0.60-0.62ï¼‰
- âœ… è®­ç»ƒç¨³å®šï¼Œæ— è¿‡æ‹Ÿåˆ

---

## æ€»ç»“

é€šè¿‡5ä¸ªå…³é”®ä¿®å¤ï¼Œæˆ‘ä»¬é¢„æœŸï¼š
1. **LEVæŒ‡æ ‡æ”¹å–„73%**ï¼ˆ29.90 â†’ <8ï¼‰
2. **ä½ç½®è¯¯å·®æ”¹å–„30%**ï¼ˆ0.40 â†’ 0.28ï¼‰
3. **Yå‡å€¼åå·®ä¿®å¤**ï¼ˆ0.61 â†’ 0.50ï¼‰
4. **è®­ç»ƒæ›´ç¨³å®š**ï¼ˆé¿å…è¿‡æ‹Ÿåˆï¼‰

æ‰€æœ‰ä¿®å¤å·²å®æ–½å®Œæˆï¼Œå¯ä»¥å¼€å§‹è®­ç»ƒï¼
